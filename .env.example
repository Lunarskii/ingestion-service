# -----------------------------------------------------------------------------
# Пример файла переменных окружения для сервиса Ingestion Service.
#
# Инструкции по использованию:
#  - Скопируйте этот файл в .env и заполните реальные значения.
#  - НЕ коммитьте реальные секреты (client_secret, пароли, API-ключи) в репозиторий.
#  - Типы принимаются как строки для поддержки:
#      - boolean значения принимаются как "True"/"False",
#      - Числовые (integer, float и др.) значения принимаются как "123"/"0.2"/.
#      - Без значения (None, null и др.) значения принимаются как "None".
# -----------------------------------------------------------------------------


# **Настройки API**

# Заголовок API, отображается в UI Swagger.
# [default: "Ingestion Service"]
API_TITLE="Ingestion Service"

# Описание API (Markdown), выводится под заголовком в Swagger.
# [default: ""]
API_DESCRIPTION=""

# Версия API, будет отображаться рядом с заголовком.
# [default: "0.1.0"]
API_VERSION="0.1.0"

# URL, по которому доступна спецификация OpenAPI. Можно отключить (None).
# [default: "/openapi.json"]
OPENAPI_URL="/openapi.json"

# Префикс для всех путей OpenAPI (например, если API за reverse-proxy под /api/v1).
# [default: ""]
OPENAPI_PREFIX=""

# URL Swagger UI. Можно отключить (None) или изменить (e.g. /api/docs).
# [default: "/docs"]
DOCS_URL="/docs"

# URL ReDoc. Можно отключить (None) или изменить (e.g. /api/redoc).
# [default: "None"]
REDOC_URL="None"

# Если API за proxy с префиксом (например, 'X-Forwarded-Prefix'), указываете его здесь.
# [default: ""]
ROOT_PATH=""

# Включить зависимость от заголовка X-API-Key для безопасности API.
# В prod обязательно должно быть включено; "False" только для разработки и тестирования.
# [default: "True"]
API_KEY_REQUIRED="True"

# Включить зависимость от аутентификации/авторизации (Keycloak) для безопасности API.
# В prod обязательно должно быть включено; "False" только для разработки и тестирования.
# [default: "True"]
API_AUTH_REQUIRED="True"


# **Настройки базы данных**

# URL для подключения к базе данных
# Схема URL - "dialect+driver://username:password@host:port/dbname"
# [default: "sqlite+aiosqlite:///./local_storage/sqlite.db"]
DATABASE_URL="postgresql+asyncpg://postgres:postgres@localhost:5432/postgres"

# Включает логирование SQL-запросов/операций SQLAlchemy на stdout (или в логгер).
# [default: "False"]
DATABASE_ECHO="False"

# Включает логирование событий пула подключений (чек-аут / возврат соединения)
# [default: "False"]
DATABASE_ECHO_POOL="False"

# Перед выдачей соединения проверяет "alive"-состояние (ping) соединения.
# Если соединение закрыто на стороне сервера, пул выбрасывает его и создаёт новое.
# Это помогает избежать ошибок из-за таймаута/закрытия соединений со стороны БД (особенно у облачных провайдеров).
# [default: "True"]
DATABASE_POOL_PRE_PING="True"

# Когда True, перед выполнением запросов (query/scalar и т.п.) Session автоматически вызывает flush(),
# т.е. отправляет в БД все накопленные изменения (INSERT/UPDATE/DELETE), чтобы результаты запросов
# были последовательны с текущим состоянием сессии.
# [default: "False"]
DATABASE_AUTO_FLUSH="False"

# В старых версиях SQLAlchemy autocommit=True переводило сессию в "режим без транзакции",
# т.е. позволялo выполнять операции без явного begin() / commit().
# Устарел/удалён в подходе SQLAlchemy 2.0; его использование не рекомендуется.
# [default: "False"]
DATABASE_AUTO_COMMIT="False"

# После коммита объекты в сессии помечаются как expired - при следующем доступе к атрибуту
# SQLAlchemy попытается автоматически подгрузить актуальные данные из БД (выполнит SELECT).
# Если False, объекты остаются валидными в памяти и не будут автоматически "проверяться"/обновляться после коммита.
# [default: "False"]
DATABASE_EXPIRE_ON_COMMIT="False"


# **Настройки ограничений документа**

# Максимальный размер загружаемого документа в 'POST /v1/documents/upload'
# [default: "25"]
DR_MAX_UPLOAD_MB="25"

# Разрешенные расширения документа в 'POST /v1/documents/upload'
# [default: '[".pdf", ".docx"]']
DR_ALLOWED_EXTENSIONS='[".pdf", ".docx"]'


# **Настройки эмбеддинг модели**

# Название модели (подготовленная заранее в SentenceTransformer, или Hugging Face Hub) или путь к модели на диске.
# [default: "sentence-transformers/LaBSE"]
EMBEDDING_MODEL_NAME="sentence-transformers/LaBSE"

# Устройство (например, "cuda", "cpu", "mps", "npu"), которое должно использоваться для вычислений.
# Если None, проверяет, можно ли использовать графический процессор.
# [default: "None"]
EMBEDDING_DEVICE="None"

# Путь к хранилищу моделей. Также может быть задан переменной окружения SENTENCE_TRANSFORMERS_HOME.
# [default: "None"]
EMBEDDING_CACHE_FOLDER="None"

# Аутентификационный токен Hugging Face для загрузки приватных моделей.
# [default: "None"]
EMBEDDING_TOKEN="None"

# Количество элементов данных, обрабатываемых за один шаг.
# [default: "32"]
EMBEDDING_BATCH_SIZE="32"


# **Настройки разделителя текста**

# Максимальная длина одного фрагмента в символах.
# [default: "500"]
TEXT_SPLITTER_CHUNK_SIZE="500"

# Число символов перекрытия между соседними фрагментами.
# [default: "50"]
TEXT_SPLITTER_CHUNK_OVERLAP="50"


# **Настройки заглушек для локальной разработки**

# Путь для хранения необработанных документов.
# [default: "./local_storage/raw/"]
RAW_STORAGE_PATH="./local_storage/raw/"

# Путь для хранения обработанных документов.
# [default: "./local_storage/silver/"]
SILVER_STORAGE_PATH="./local_storage/silver/"

# Путь для хранения векторных документов.
# [default: "./local_storage/index/"]
INDEX_PATH="./local_storage/index/"


# **Настройки MinIO**

# Адрес MinIO/S3-совместимого сервера.
# Обычно в виде host:port (например minio.local:9000) или URL без схемы.
# [default: "None"]
MINIO_ENDPOINT="None"

# Имя бакета (bucket), в котором будут храниться сырые файлы.
# [default: "raw-zone"]
MINIO_BUCKET_RAW="raw-zone"

# Имя бакета (bucket), в котором будут храниться обработанные файлы.
# [default: "silver-zone"]
MINIO_BUCKET_SILVER="silver-zone"

# Публичный ключ / идентификатор доступа для аутентификации к MinIO/S3.
# [default: "None"]
MINIO_ACCESS_KEY="None"

# Секретный ключ для подписи запросов к сервису MinIO/S3.
# [default: "None"]
MINIO_SECRET_KEY="None"

# Временный (STS) токен сессии - используется вместе с access_key/secret_key для временных учётных записей.
# [default: "None"]
MINIO_SESSION_TOKEN="None"

# Флаг, указывающий, использовать ли TLS/HTTPS при подключении к адресу MinIO/S3.
# [default: "False"]
MINIO_SECURE="False"

# Имя региона (например, 'us-east-1') - может влиять на создание бакетов и некоторые клиентские настройки.
# [default: "None"]
MINIO_REGION="None"


# **Настройки Qdrant**

# URL сервера Qdrant
# [default: "None"]
QDRANT_URL="None"

# Имя коллекции
# [default: "notebook_chunks"]
QDRANT_COLLECTION="notebook_chunks"

# Хост (альтернативный способ указания адреса)
# [default: "None"]
QDRANT_HOST="None"

# HTTP-порт
# [default: "6333"]
QDRANT_PORT="6333"

# gRPC-порт
# [default: "6334"]
QDRANT_GRPC_PORT="6334"

# API-ключ для доступа (если требуется)
# [default: "None"]
QDRANT_API_KEY="None"

# Использовать HTTPS
# [default: "False"]
QDRANT_USE_HTTPS="False"

# Предпочитать gRPC соединение
# [default: "False"]
QDRANT_PREFER_GRPC="False"

# Таймаут запросов (секунды)
# [default: "30"]
QDRANT_TIMEOUT="30"

# Размерность векторов (число измерений)
# [default: "768"]
QDRANT_VECTOR_SIZE="768"

# Функция расстояния
# Может быть "Dot", "Cosine", "Euclid" и "Manhattan"
# Подробнее - https://qdrant.tech/documentation/concepts/search/#metrics
# [default: "Cosine"]
QDRANT_DISTANCE="Cosine"


# **Настройки Ollama**

# URL сервера Ollama
# [default: "None"]
OLLAMA_URL="None"

# API-ключ для доступа (если требуется)
# [default: "None"]
OLLAMA_API_KEY="None"

# Название модели из реестра Ollama
# [default: "None"]
OLLAMA_MODEL="None"

# Таймаут для ответов Ollama API
# [default: "30"]
OLLAMA_TIMEOUT_SECONDS="30"


# **Настройки логирования**

# Уровень логирования (TRACE, DEBUG, INFO, SUCCESS, WARNING, ERROR, CRITICAL)
# [default: "INFO"]
LOG_LEVEL="INFO"

# Формат лога, например "{time} - {level} - {message}"
# Подробнее: https://loguru.readthedocs.io/en/stable/api/logger.html#record
# [default: "{message}"]
LOG_FORMAT="{message}"

# Сериализация в JSON. Может быть True или False
# [default: "True"]
LOG_SERIALIZE="True"

# Ротация логов, например "1 day"
# Подробнее: https://loguru.readthedocs.io/en/stable/api/logger.html#time
# [default: "1 day"]
LOG_ROTATION="1 day"

# Параметр определяет - какие и сколько старых файлов логов вы хотите хранить, а какие автоматически удалять.
# Если вы задаёте его как строку с единицами измерения, например "7 days", то будут сохраняться только архивы логов
# за последние семь дней, а более старые файлы автоматически удалятся. Можно указать ограничение по количеству файлов,
# например "10 files" - будет храниться только 10 самых свежих лог‑архивов.
# Подробнее: https://loguru.readthedocs.io/en/stable/api/logger.html#file
# [default: "14 days"]
LOG_RETENTION="14 days"

# Параметр указывает, как архивировать старые лог-файлы при ротации. Когда достигается условие ротации
# (по размеру, времени и т.п.), текущий лог-файл переименовывается и, если вы задали compression,
# дополнительно сжимается.
# Подробнее: https://loguru.readthedocs.io/en/stable/api/logger.html#file
# [default: "zip"]
LOG_COMPRESSION="zip"


# **Настройки времени**

# Формат сериализации даты и времени.
# В этот формат будут сериализованы все 'datetime' поля, отдаваемые API.
# Подробнее о формате - https://docs.python.org/3/library/datetime.html#format-codes
# [default: "%Y-%m-%d %H:%M:%S"]
DATETIME_SERIALIZATION_FORMAT="%Y-%m-%d %H:%M:%S"


# **Настройки Keycloak**

# URL сервера Keycloak
# [default: "None"]
KEYCLOAK_URL="None"

# client_id зарегистрированного клиента в Keycloak.
# [default: "None"]
KEYCLOAK_CLIENT_ID="None"

# client_secret (если используется confidential client).
# [default: "None"]
KEYCLOAK_CLIENT_SECRET="None"

# Имя реалма в Keycloak.
# [default: "None"]
KEYCLOAK_REALM="None"

# URI перенаправления, указываемый при авторизации.
# [default: "None"]
KEYCLOAK_REDIRECT_URI="None"

# scope для запроса авторизации.
# [default: "openid email profile"]
KEYCLOAK_SCOPE="openid email profile"


# **Настройки Celery**

# URL брокера сообщений, который использует Celery для очередей задач.
# Подробнее о брокерах - https://docs.celeryq.dev/en/stable/getting-started/backends-and-brokers/index.html
# [default: "None", required]
CELERY_BROKER_URL="None"

# URL бэкенда для хранения результатов задач.
# [default: "None", required]
CELERY_RESULT_BACKEND="None"

# Включает использование UTC для внутренних времён Celery (scheduling, ETA и т.п.).
# [default: "True"]
CELERY_ENABLE_UTC="True"

# Часовой пояс, используемый для расписаний/ETA (например, Europe/Moscow, UTC).
# Работает вместе с CELERY_ENABLE_UTC. Если указан, Celery приведёт время к этому часовому поясу.
# [default: "UTC"]
CELERY_TIMEZONE="UTC"

# Если True, подтверждение (ack) задачи брокеру выполняется после успешного
# выполнения задачи. Это защищает от потери задач, но может привести к повторным запускам
# при падении воркера в процессе обработки (задача будет переотдана другому воркеру).
# [default: "True"]
CELERY_TASK_ACKS_LATE="True"

# Жёсткий лимит времени (в секундах) выполнения задачи.
# При превышении времени процесс будет принудительно убит (SIGKILL/эквивалент).
# Рекомендация устанавливать значение чуть больше типичного максимального времени выполнения.
# Для тяжёлых задач (парсинг больших файлов, ML-инференс) - увеличить.
# На некоторые задачи этот лимит не будет влиять, если на них проставлен индивидуальный лимит.
# [default: "300"]
CELERY_TASK_TIME_LIMIT="300"

# Мягкий лимит выполнения задачи (в секундах). Когда он срабатывает, воркер посылает
# задаче исключение SoftTimeLimitExceeded, что даёт шанс корректно очистить ресурсы.
# Если задача не поймает это исключение, сработает task_time_limit.
# Рекомендация устанавливать мягкий лимит немного меньше жёсткого (task_time_limit) чтобы
# успеть нормально завершить работу/освободить ресурсы.
# На некоторые задачи этот лимит не будет влиять, если на них проставлен индивидуальный лимит.
# [default: "270"]
CELERY_TASK_SOFT_TIME_LIMIT="270"

# Максимальное количество повторов (retries) для задач по умолчанию при неудаче.
# На некоторые задачи этот лимит не будет влиять, если на них проставлен индивидуальный лимит.
# [default: "5"]
CELERY_TASK_MAX_RETRIES="5"

# Базовый множитель для экспоненциальной задержки между попытками повторного выполнения.
# Если retry_backoff=True/число - Celery будет увеличивать паузу: retry_backoff * (2^attempt).
# Рекомендации: Небольшой положительный множитель (2) хорош для большинства задач;
# для агрессивного сокращения нагрузки увеличить.
# [default: "2"]
CELERY_TASK_RETRY_BACKOFF="2"

# Добавлять случайное смещение (jitter) к задержке retry, чтобы избежать одновременной
# перезаписи большого числа задач.
# [default: "True"]
CELERY_TASK_RETRY_JITTER="True"

# Количество задач, которое каждый воркер предварительно забирает из очереди для
# обработки. Если prefetch_multiplier=1, воркер берёт ровно concurrency * 1 задач.
# Низкое значение уменьшает задержку и конкурентные блокировки.
# Высокое значение повышает пропускную способность, но может привести к
# замораживанию задач на одном воркере.
# Рекомендация увеличивать для IO-bound/быстрых задач; для тяжёлых/длинных задач ставить 1,
# чтобы избежать удержания задач одним воркером.
# [default: "1"]
CELERY_WORKER_PREFETCH_MULTIPLIER="1"

# Хост, на котором будут запущены Celery-метрики.
# [default: "localhost"]
CELERY_METRICS_HOST="localhost"

# Порт, на котором будут запущены Celery-метрики.
# [default: "9091"]
CELERY_METRICS_PORT="9091"

# Интервал сбора метрик с Celery-событий.
# [default: "5"]
CELERY_COLLECT_EVENTS_METRICS_INTERVAL_S="5"

# Интервал сбора метрик с Celery-очередей.
# [default: "5"]
CELERY_COLLECT_QUEUE_METRICS_INTERVAL_S="5"


# **Настройки исключений**

# Подробности ошибок. Если установлено "debug", то при исключениях в API возвращается
# также поле "debug_message"
# В prod обязательно должно быть "safe"; "debug" только для разработки и тестирования.
# [default: "safe"]
ERROR_DETAIL_LEVEL="safe"


# **Настройки классификатора тем**

# Путь к YAML файлу с темами документов.
# [default: "./topics.yml"]
CLASSIFIER_TOPICS_PATH="./topics.yml"

# Путь к YAML файлу с правилами для тем документов.
# [default: "./rules.yml"]
CLASSIFIER_RULES_PATH="./rules.yml"

# Количество предлагаемых тем после классификации текста, по умолчанию.
# [default: "5"]
CLASSIFIER_DEFAULT_TOP_K="5"


# **Настройки чата**

# Лимит памяти истории сообщений чата. Чем больше значение указано,
# тем больше будет контекст для LLM при отправке нового вопроса в чат.
# [default: "4"]
CHAT_HISTORY_MEMORY_LIMIT="4"
