# docker-compose.local.yml — локальная конфигурация для разработки / тестирования Qdrant + MinIO
# Этот файл использует **bind mounts** — данные будут храниться в указанных папках на хосте.
# Использование: docker compose -f docker-compose.local.yml up -d

# Примечания по персистентности данных
# - В этой конфигурации данные будут храниться на хосте в:
#     Qdrant: ./qdrant
#     MinIO: ./minio
# - Создайте эти директории на хосте до запуска и установите корректные права:
#     sudo mkdir ./qdrant ./minio
#     sudo chown $(id -u):$(id -g) /usr/local/share/qdrant /usr/local/share/minio
# - Это даст вашему текущему пользователю права на эти папки; при необходимости настройте иначе.

services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant_local
    ports:
      - "6333:6333" # HTTP API
      - "6334:6334" # gRPC API
    volumes:
      - ./qdrant:/qdrant/storage
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/collections"]
      interval: 30s
      timeout: 10s
      retries: 3

  minio:
    image: minio/minio:latest
    container_name: minio_local
    ports:
      - "9000:9000" # S3 API
      - "9001:9001" # S3 UI
    environment:
      MINIO_ROOT_USER: "${MINIO_ROOT_USER:-access_key}"
      MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD:-secret_key}"
      MINIO_COMPRESSION_ENABLE: "${MINIO_COMPRESSION_ENABLE:-on}"
      MINIO_COMPRESSION_EXTENSIONS: "${MINIO_COMPRESSION_EXTENSIONS:-.pdf}"
      MINIO_COMPRESSION_MIME_TYPES: "${MINIO_COMPRESSION_MIME_TYPES:-application/pdf}"
    volumes:
      - ./minio:/data
    command: server /data --address ":9000" --console-address ":9001"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:9000/minio/health/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  keycloak:
    image: quay.io/keycloak/keycloak:26.3
    container_name: keycloak_local
    ports:
      - "8080:8080"
    extra_hosts:
      - "host.docker.internal:172.17.0.1"
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: "${KC_BOOTSTRAP_ADMIN_USERNAME:-admin}"
      KC_BOOTSTRAP_ADMIN_PASSWORD: "${KC_BOOTSTRAP_ADMIN_PASSWORD:-admin}"
      KC_DB: "${KC_DB:-postgres}"
      KC_DB_URL_HOST: "${KC_DB_URL_HOST:-host.docker.internal}"
      KC_DB_URL_PORT: "${KC_DB_URL_PORT:-5432}"
      KC_DB_URL_DATABASE: "${KC_DB_URL_DATABASE:-postgres}"
      KC_DB_USERNAME: "${KC_DB_USERNAME:-postgres}"
      KC_DB_PASSWORD: "${KC_DB_PASSWORD:-postgres}"
    command: start-dev

  redis:
    image: redis:8.2.1
    container_name: redis_local
    ports:
      - "6379:6379"
