volumes:
  prometheus_data:

networks:
  api_network:
  redis_network:

services:
  api:
    build:
      context: .
      dockerfile: docker/api.dockerfile
    container_name: api
    restart: on-failure
    environment:
      DATABASE_URL: "${DATABASE_URL}"
      MINIO_ENDPOINT: "${MINIO_ENDPOINT}"
      MINIO_ACCESS_KEY: "${MINIO_ACCESS_KEY}"
      MINIO_SECRET_KEY: "${MINIO_SECRET_KEY}"
      QDRANT_URL: "${QDRANT_URL}"
      CELERY_BROKER_URL: "${CELERY_BROKER_URL}"
      CELERY_RESULT_BACKEND: "${CELERY_RESULT_BACKEND}"
      KEYCLOAK_URL: "${KEYCLOAK_URL}"
      KEYCLOAK_CLIENT_ID: "${KEYCLOAK_CLIENT_ID}"
      KEYCLOAK_CLIENT_SECRET: "${KEYCLOAK_CLIENT_SECRET}"
      KEYCLOAK_REALM: "${KEYCLOAK_REALM}"
      KEYCLOAK_REDIRECT_URI: "${KEYCLOAK_REDIRECT_URI}"
      API_KEY_REQUIRED: "${API_KEY_REQUIRED}"
      OLLAMA_HOST: "${OLLAMA_HOST}"
      OLLAMA_MODEL: "${OLLAMA_MODEL}"
      OLLAMA_TIMEOUT_SECONDS: "${OLLAMA_TIMEOUT_SECONDS}"
    ports:
      - "8000:8000"
    networks:
      - api_network
      - redis_network
    depends_on:
      - celery_worker

  celery_worker:
    build:
      context: .
      dockerfile: docker/celery_worker.dockerfile
    container_name: celery_worker
    restart: on-failure
    environment:
      DATABASE_URL: "${DATABASE_URL}"
      MINIO_ENDPOINT: "${MINIO_ENDPOINT}"
      MINIO_ACCESS_KEY: "${MINIO_ACCESS_KEY}"
      MINIO_SECRET_KEY: "${MINIO_SECRET_KEY}"
      QDRANT_URL: "${QDRANT_URL}"
      CELERY_BROKER_URL: "${CELERY_BROKER_URL}"
      CELERY_RESULT_BACKEND: "${CELERY_RESULT_BACKEND}"
    networks:
      - redis_network
    depends_on:
      - redis

  celery_beat:
    build:
      context: .
      dockerfile: docker/celery_beat.dockerfile
    container_name: celery_beat
    restart: on-failure
    environment:
      CELERY_BROKER_URL: "${CELERY_BROKER_URL}"
      CELERY_RESULT_BACKEND: "${CELERY_RESULT_BACKEND}"
    networks:
      - redis_network
    depends_on:
      - celery_worker

  celery_exporter:
    build:
      context: .
      dockerfile: docker/celery_exporter.dockerfile
    container_name: celery_exporter
    restart: on-failure
    environment:
      CELERY_BROKER_URL: "${CELERY_BROKER_URL}"
      CELERY_RESULT_BACKEND: "${CELERY_RESULT_BACKEND}"
      CELERY_METRICS_HOST: "${CELERY_METRICS_HOST}"
      CELERY_METRICS_PORT: "${CELERY_METRICS_PORT}"
    ports:
      - "9091:9091"
    networks:
      - redis_network

  flower:
    image: mher/flower:2.0
    container_name: flower
    environment:
      CELERY_BROKER_URL: "${CELERY_BROKER_URL}"
      RESULT_BACKEND: "${CELERY_RESULT_BACKEND}"
    ports:
      - "5555:5555"
    networks:
      - redis_network
    depends_on:
      - redis

  redis:
    image: redis:8.2.1
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - redis_network

  prometheus:
    image: prom/prometheus:v3.6.0-rc.1
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    depends_on:
      - celery_exporter

  ui:
    build:
      context: .
      dockerfile: docker/ui.dockerfile
    container_name: ui
    restart: on-failure
    environment:
      BACKEND_URL: "${BACKEND_URL:-http://api:8000}"
    ports:
      - "8501:8501"
    networks:
      - api_network
    depends_on:
      - api
